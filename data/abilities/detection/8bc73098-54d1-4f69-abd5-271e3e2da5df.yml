---
- id: 8bc73098-54d1-4f69-abd5-271e3e2da5df
  name: New scheduled tasks
  description: Checks to see if a new (unauthorized) scheduled task has been added
  tactic: detection
  technique:
    attack_id: x
    name: x
  repeatable: True
  platforms:
    windows:
      psh:
        command: |
          Get-ScheduledTask > C:\Users\Public\new_schtasks_list.txt;
          $new_schtasks =  $(Get-Content .\new_schtasks_list.txt) | Where-Object {$_ -notIn $(Get-Content .\baseline_schtasks_list.txt)} |foreach-object {(-split $_)[1]};
          Remove-Item -Path C:\Users\Public\new_schtasks_list.txt -Force;
          $new_schtasks
        parsers:
          plugins.response.app.parsers.basic_strip:
            - source: host.new.schtask
    linux:
      sh:
        command: |
          cron_list='';
          set -f;
          for user in $(getent passwd | cut -f1 -d: );
            do jobs=$(sudo crontab -u $user -l 2>/dev/null | grep -v '\#');
            if ! test -z "$jobs";
              then IFS=$(echo '\n');
              for job in $jobs;
                do cron_list="${cron_list}${user}>${job}\n";
              done;
            fi;
          done;
          echo $cron_list | sed '/^[[:space:]]*$/d' | sort > /tmp/new_cronjobs_list.txt;
          set +f;
          unset IFS;
          comm -13 /tmp/baseline_cronjobs_list.txt /tmp/new_cronjobs_list.txt;
        parsers:
          plugins.response.app.parsers.key_value:
            - source: host.user.name
              edge: has_new_cronjob
              target: host.new.cronjob
    darwin:
      sh:
        command: |
          cron_list='';
          set -f;
          for user in $(getent passwd | cut -f1 -d: );
            do jobs=$(sudo crontab -u $user -l 2>/dev/null | grep -v '\#');
            if ! test -z "$jobs";
              then IFS=$(echo '\n');
              for job in $jobs;
                do cron_list="${cron_list}${user}>${job}\n";
              done;
            fi;
          done;
          echo $cron_list | sed '/^[[:space:]]*$/d' | sort > /tmp/new_cronjobs_list.txt;
          set +f;
          unset IFS;
          comm -13 /tmp/baseline_cronjobs_list.txt /tmp/new_cronjobs_list.txt;
        parsers:
          plugins.response.app.parsers.key_value:
            - source: host.user.name
              edge: has_new_cronjob
              target: host.new.cronjob
