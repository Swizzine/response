- id: 34bc0116-13b6-4dd5-b681-9554c2a1fa95
  name: Backup Sensitive Files
  description: Backup sensitive files to temp directory in case these files are maliciously modified
  tactic: setup
  technique:
    attack_id: x
    name: x
  repeatable: False
  platforms:
    linux:
      sh:
        command: |
          mkdir -p /tmp/sensitive_file_backups;
          files=$(find #{file.sensitive.path} 2>/dev/null);
          output="";
          for file in ${files[@]};
            do randname=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 13);
            cp $file /tmp/sensitive_file_backups/$randname;
            output="${output}${file}>${randname}\n";
          done;
          echo $output | sed '/^[[:space:]]*$/d'
        parsers:
          plugins.response.app.parsers.key_value:
            - source: file.sensitive.path
              edge: has_backup
              target: file.backup.name
    darwin:
      sh:
        command: |
          mkdir -p /tmp/sensitive_file_backups;
          files=$(find #{file.sensitive.path} 2>/dev/null);
          output="";
          for file in ${files[@]};
            do randname=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 13);
            cp $file /tmp/sensitive_file_backups/$randname;
            output="${output}${file}>${randname}\n";
          done;
          echo $output | sed '/^[[:space:]]*$/d'
        parsers:
          plugins.response.app.parsers.key_value:
            - source: file.sensitive.path
              edge: has_backup
              target: file.backup.name
    windows:
      psh:
        command: |
          New-Item -ItemType Directory -Force -Path C:\Users\Public\sensitive_file_backups;
          $output = '';
          Get-ChildItem -Path #{file.sensitive.path} | foreach-object {
            $randname = -join (( 0x41..0x5A) + ( 0x61..0x7A) | Get-Random -Count 13 | % {[char]$_});
            Copy-Item $_.FullName -Destination "C:\Users\Public\sensitive_file_backups\$randname";
            $output = "$($output)$($randname)>$($_.FullName)`n"
          };
          $output;
        parsers:
          plugins.response.app.parsers.key_value:
            - source: file.sensitive.path
              edge: has_backup
              target: file.backup.name