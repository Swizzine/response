---
- id: 4744d99f-5fea-42a8-8ec4-c228db57caea
  name: Remove Unauthorized Scheduled Task
  description: Removes newly added scheduled tasks
  tactic: response
  technique:
    attack_id: x
    name: x
  repeatable: True
  platforms:
    windows:
      psh:
        command: |
          Unregister-ScheduledTask -TaskName #{host.new.schtask}
        requirements:
          - plugins.stockpile.app.requirements.paw_provenance:
              - source: host.new.schtask
    linux:
      sh:
        command: |
          line=$(echo '#{host.new.cronjob}' | sed 's/\*/\\\*/g');
          crontab -u #{host.user.name} -l > temp_crontab;
          line_number=$(grep -n $line temp_crontab | cut -d':' -f1);
          sed "${line_number}d" temp_crontab > new_crontab;
          crontab -u #{host.user.name} new_crontab;
          rm -f temp_crontab new_crontab;
        requirements:
          - plugins.stockpile.app.requirements.basic:
            - source: host.user.name
              target: has_new_cronjob
              edge: host.new.cronjob
          - plugins.stockpile.app.requirements.paw_provenance:
            - source: host.new.cronjob
    darwin:
      sh:
        command: |
          line=$(echo '#{host.new.cronjob}' | sed 's/\*/\\\*/g');
          crontab -u #{host.user.name} -l > temp_crontab;
          line_number=$(grep -n $line temp_crontab | cut -d':' -f1);
          sed "${line_number}d" temp_crontab > new_crontab;
          crontab -u #{host.user.name} new_crontab;
          rm -f temp_crontab new_crontab;
        requirements:
          - plugins.stockpile.app.requirements.basic:
              - source: host.user.name
                target: has_new_cronjob
                edge: host.new.cronjob
          - plugins.stockpile.app.requirements.paw_provenance:
              - source: host.new.cronjob